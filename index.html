<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadant India CRM | Enterprise Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .sidebar-active { background: rgba(34, 211, 238, 0.1); color: #22d3ee; border-left: 4px solid #22d3ee; }
        input, select { background: #0f172a !important; border: 1px solid #334155 !important; color: white !important; padding: 10px !important; border-radius: 8px !important; }
        .pareto-tag { background: linear-gradient(to r, #f59e0b, #d97706); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- EXCEL UTILITY SERVICE ---
        const ExcelService = {
            exportToExcel: (data, fileName) => {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, `${fileName}.xlsx`);
            },
            importFromExcel: (file, callback) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    callback(json);
                };
                reader.readAsArrayBuffer(file);
            }
        };

        function App() {
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('current_user')) || null);
            const [view, setView] = useState('dashboard');
            const [customers, setCustomers] = useState(JSON.parse(localStorage.getItem(`cust_${user?.email}`)) || []);
            const [visits, setVisits] = useState(JSON.parse(localStorage.getItem(`vis_${user?.email}`)) || []);

            useEffect(() => {
                if(user) {
                    localStorage.setItem(`cust_${user.email}`, JSON.stringify(customers));
                    localStorage.setItem(`vis_${user.email}`, JSON.stringify(visits));
                }
            }, [customers, visits, user]);

            if (!user) return <Login onLogin={(u) => { setUser(u); localStorage.setItem('current_user', JSON.stringify(u)); }} />;

            return (
                <div className="flex min-h-screen">
                    {/* Sidebar */}
                    <aside className="w-64 glass border-r border-slate-800 flex flex-col hidden md:flex">
                        <div className="p-6">
                            <h1 className="text-cyan-400 font-black text-xl tracking-tighter">KADANT INDIA</h1>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Analytics Dashboard</p>
                        </div>
                        <nav className="flex-1">
                            <NavItem active={view === 'dashboard'} onClick={() => setView('dashboard')} label="Dashboard (80/20)" icon="ðŸ“ˆ" />
                            <NavItem active={view === 'customers'} onClick={() => setView('customers')} label="Customers" icon="ðŸ¢" />
                            <NavItem active={view === 'visits'} onClick={() => setView('visits')} label="Visits" icon="ðŸ“…" />
                        </nav>
                        <div className="p-4 border-t border-slate-800 text-xs text-slate-500">
                             {user.email} <br/>
                             <button onClick={() => { setUser(null); localStorage.removeItem('current_user'); }} className="text-red-400 mt-2 font-bold uppercase">Sign Out</button>
                        </div>
                    </aside>

                    <main className="flex-1 p-8 overflow-y-auto">
                        {view === 'dashboard' && <Dashboard customers={customers} visits={visits} />}
                        {view === 'customers' && <CustomersView customers={customers} setCustomers={setCustomers} />}
                        {view === 'visits' && <VisitsView visits={visits} setVisits={setVisits} customers={customers} />}
                    </main>
                </div>
            );
        }

        const NavItem = ({ active, onClick, label, icon }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold transition-all ${active ? 'sidebar-active' : 'text-slate-400 hover:text-white'}`}>
                <span>{icon}</span> {label}
            </button>
        );

        function Login({ onLogin }) {
            const [email, setEmail] = useState('');
            return (
                <div className="h-screen flex items-center justify-center bg-slate-950">
                    <div className="glass p-10 rounded-3xl w-full max-w-md">
                        <h2 className="text-2xl font-black text-center mb-6">Enterprise Login</h2>
                        <input type="email" placeholder="email@kadant.com" className="w-full mb-4" onChange={e => setEmail(e.target.value)} />
                        <button onClick={() => email && onLogin({email})} className="w-full bg-cyan-600 p-4 rounded-xl font-bold uppercase tracking-widest">Enter Portal</button>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD WITH 80/20 ANALYSIS ---
        function Dashboard({ customers, visits }) {
            const analysis = useMemo(() => {
                // Group Revenue by Customer
                const revenueMap = visits.reduce((acc, v) => {
                    acc[v.company] = (acc[v.company] || 0) + (parseFloat(v.value) || 0);
                    return acc;
                }, {});

                // Sort Customers by Revenue
                const sorted = Object.entries(revenueMap)
                    .sort(([, a], [, b]) => b - a)
                    .map(([name, val]) => ({ name, val }));

                const totalRevenue = sorted.reduce((acc, curr) => acc + curr.val, 0);

                // Identify 80/20 (Pareto)
                let cumulative = 0;
                const paretoCustomers = sorted.filter(c => {
                    cumulative += c.val;
                    return cumulative <= totalRevenue * 0.8;
                });

                return { sorted, totalRevenue, paretoCount: paretoCustomers.length, paretoCustomers };
            }, [visits]);

            return (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <header className="flex justify-between items-end">
                        <div>
                            <h2 className="text-3xl font-black">Strategic Analytics</h2>
                            <p className="text-slate-500">Pareto (80/20) and Top Customer ranking.</p>
                        </div>
                        <div className="text-right">
                            <p className="text-xs text-slate-500 uppercase font-bold tracking-widest">Global Pipeline</p>
                            <p className="text-4xl font-black text-emerald-400">â‚¬{analysis.totalRevenue.toLocaleString()}</p>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* 80/20 Rule Card */}
                        <div className="glass p-8 rounded-3xl border-amber-500/20">
                            <div className="flex justify-between items-start mb-6">
                                <h3 className="text-lg font-bold text-amber-400">80/20 Rule (Pareto)</h3>
                                <span className="pareto-tag">CRITICAL FEW</span>
                            </div>
                            <p className="text-slate-400 text-sm mb-4">
                                <b>{analysis.paretoCount} customers</b> contribute to 80% of your total revenue. 
                                Focus service audits on these sites to maximize efficiency.
                            </p>
                            <div className="space-y-3">
                                {analysis.paretoCustomers.map((c, i) => (
                                    <div key={i} className="flex justify-between text-sm">
                                        <span className="text-slate-200">{i+1}. {c.name}</span>
                                        <span className="text-amber-500 font-bold">{((c.val / analysis.totalRevenue) * 100).toFixed(1)}%</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Top Customers Leaderboard */}
                        <div className="glass p-8 rounded-3xl">
                            <h3 className="text-lg font-bold text-cyan-400 mb-6">Top Customers Leaderboard</h3>
                            <div className="space-y-4">
                                {analysis.sorted.slice(0, 5).map((c, i) => (
                                    <div key={i} className="flex items-center justify-between p-3 bg-slate-900/50 rounded-xl border border-slate-800">
                                        <div className="flex items-center gap-3">
                                            <span className="text-slate-500 font-mono">#0{i+1}</span>
                                            <span className="font-bold">{c.name}</span>
                                        </div>
                                        <span className="text-emerald-400 font-black">â‚¬{c.val.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- CUSTOMERS WITH IMPORT/EXPORT ---
        function CustomersView({ customers, setCustomers }) {
            const handleImport = (e) => {
                ExcelService.importFromExcel(e.target.files[0], (data) => {
                    const sanitized = data.map(item => ({
                        id: Date.now() + Math.random(),
                        name: item.Name || item.company || 'Unknown',
                        code: item.Code || item.customer_code || 'N/A',
                        country: item.Country || 'India'
                    }));
                    setCustomers([...customers, ...sanitized]);
                });
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">Customer Management</h2>
                        <div className="flex gap-2">
                            <input type="file" id="importCust" className="hidden" onChange={handleImport} />
                            <label htmlFor="importCust" className="cursor-pointer bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold uppercase">Import Excel</label>
                            <button onClick={() => ExcelService.exportToExcel(customers, 'Kadant_Customers')} className="bg-cyan-600 px-4 py-2 rounded-lg text-xs font-bold uppercase">Export Excel</button>
                        </div>
                    </div>
                    <div className="glass rounded-2xl overflow-hidden">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-800/50 text-slate-500 uppercase tracking-widest font-bold">
                                <tr><th className="p-4">Site Name</th><th className="p-4">Customer Code</th><th className="p-4">Country</th></tr>
                            </thead>
                            <tbody>
                                {customers.map(c => (
                                    <tr key={c.id} className="border-t border-slate-800">
                                        <td className="p-4 font-bold">{c.name}</td>
                                        <td className="p-4 text-slate-400 font-mono">{c.code}</td>
                                        <td className="p-4">{c.country}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- VISITS WITH IMPORT/EXPORT ---
        function VisitsView({ visits, setVisits, customers }) {
            const handleImport = (e) => {
                ExcelService.importFromExcel(e.target.files[0], (data) => {
                    const sanitized = data.map(item => ({
                        id: Date.now() + Math.random(),
                        company: item.Company || item.Client || 'Unknown',
                        value: item.Value || item.Opportunity || 0,
                        status: item.Status || 'Planned',
                        type: item.Type || 'Process Audit'
                    }));
                    setVisits([...visits, ...sanitized]);
                });
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">Visit & Audit Schedule</h2>
                        <div className="flex gap-2">
                            <input type="file" id="importVis" className="hidden" onChange={handleImport} />
                            <label htmlFor="importVis" className="cursor-pointer bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold uppercase">Import Excel</label>
                            <button onClick={() => ExcelService.exportToExcel(visits, 'Kadant_Visits')} className="bg-cyan-600 px-4 py-2 rounded-lg text-xs font-bold uppercase">Export Excel</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 gap-4">
                        {visits.map(v => (
                            <div key={v.id} className="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-cyan-500">
                                <div>
                                    <h4 className="font-bold text-white uppercase">{v.company}</h4>
                                    <p className="text-[10px] text-slate-500">{v.type} â€¢ {v.status}</p>
                                </div>
                                <p className="text-emerald-400 font-black">â‚¬{Number(v.value).toLocaleString()}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
